<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Applicant Platform</title>
    <!-- Charts and Exports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: rgb(45,190,127);
            --primary-dark: rgb(30,150,100);
            --primary-light: #e1fff1;
            --gradient: linear-gradient(135deg, rgb(45,190,127) 0%, rgb(30,150,100) 100%);
            --text-dark: #212a2d;
            --text-light: #6e8480;
            --bg-light: #f6fdfa;
            --white: #fff;
            --gray-100: #f6fdfa;
            --gray-200: #e9f6f0;
            --gray-300: #d0ede1;
            --success: #38A169;
            --warning: #D69E2E;
            --error: #E53E3E;
            --info: #3182CE;
            --shadow-card: 0 4px 24px rgba(45,190,127,0.09);
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--gradient);
            color: var(--text-dark);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
        }
        /* Header/Nav */
        .header {
            background: var(--white);
            box-shadow: 0 2px 16px rgba(45,190,127,0.07);
            position: sticky; top: 0; z-index: 1200;
        }
        .header-content {
            display: flex; justify-content: space-between; align-items: center; padding: 1rem 0;
            flex-wrap: wrap;
        }
        .logo {
            font-size: 1.6rem; font-weight: 700; color: var(--primary-color); text-decoration: none;
            letter-spacing: 1px;
        }
        .nav-menu {
            display: flex; gap: 2rem; align-items: center;
        }
        .nav-link {
            color: var(--text-dark); text-decoration: none; font-weight: 500; padding: 0.25rem 0.5rem;
            border-radius: 5px; transition: color 0.2s, background 0.2s; cursor: pointer;
        }
        .nav-link:hover, .nav-link.active { color: var(--primary-color); background: var(--primary-light);}
        /* Responsive Nav */
        .nav-toggle {
            display: none;
            background: var(--primary-color);
            color: #fff;
            border: none;
            font-size: 1.7rem;
            padding: 0.4rem 0.9rem;
            border-radius: 8px;
            cursor: pointer;
        }
        @media (max-width: 700px) {
            .header-content { flex-direction: column; align-items: stretch; gap: 0.5rem; }
            .nav-menu {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
                display: none;
                background: var(--white);
                border-radius: 8px;
                margin-top: 0.3rem;
                box-shadow: 0 4px 24px rgba(45,190,127,0.09);
                padding: 0.5rem;
            }
            .nav-menu.show {
                display: flex;
            }
            .nav-toggle {
                display: block;
                align-self: flex-end;
            }
        }
        /* Buttons */
        .btn {
            padding: 0.7rem 1.3rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;
            transition: all 0.25s; text-decoration: none; display: inline-block; text-align: center;
            font-size: 1rem;
        }
        .btn-primary { background: var(--primary-color); color: var(--white); }
        .btn-primary:hover { background: var(--primary-dark);}
        .btn-secondary { background: var(--gray-200); color: var(--text-dark);}
        .btn-secondary:hover { background: var(--gray-300);}
        .btn-outline { background: transparent; border: 2px solid var(--primary-color); color: var(--primary-color);}
        .btn-outline:hover { background: var(--primary-color); color: var(--white);}
        .btn-sm { padding: 0.4rem 0.9rem; font-size: 0.98rem;}
        /* Forms */
        .form-group { margin-bottom: 1.25rem;}
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dark);}
        .form-input, .form-select {
            width: 100%; padding: 0.7rem; border: 2px solid var(--gray-300); border-radius: 8px; font-size: 1rem;
            transition: border-color 0.25s;
        }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary-color);}
        .form-select { background: var(--white); cursor: pointer;}
        /* Cards */
        .card {
            background: var(--white); border-radius: 16px; box-shadow: var(--shadow-card);
            overflow: hidden; transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-3px);}
        .card-header { padding: 1.3rem 1.3rem 1rem 1.3rem; background: var(--gradient); color: var(--white);}
        .card-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem;}
        .card-body { padding: 1.3rem;}
        /* Dashboard */
        .dashboard-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 2rem; margin-bottom: 3rem;
        }
        .stat-card { text-align: center; padding: 2rem;}
        .stat-number { font-size: 2.2rem; font-weight: 700; color: var(--primary-color); margin-bottom: 0.5rem;}
        .stat-label { color: var(--text-light); font-weight: 500;}
        .stat-amount { font-size: 1.07rem; margin-top: 0.2rem; color: var(--primary-dark); font-weight: 600; letter-spacing: 0.2px; }
        /* Dashboard filter cards */
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 2rem;
            margin-bottom: 2.5rem;
        }
        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.7rem;
        }
        .filter-btn {
            background: var(--gray-200);
            color: var(--primary-dark);
            border-radius: 18px;
            border: none;
            padding: 0.6rem 1.1rem;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s, color 0.2s;
        }
        .filter-btn.active, .filter-btn:active {
            background: var(--primary-color);
            color: #fff;
        }
        /* Table */
        .table-container { overflow-x: auto; margin-top: 2rem; }
        .table-search-row {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.7rem;
            align-items: center;
            flex-wrap: wrap;
        }
        .table-search-input {
            flex: 1 1 200px;
            min-width: 120px;
            padding: 0.6rem 1rem;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: border 0.2s;
        }
        .table-search-input:focus {
            border: 2px solid var(--primary-color);
        }
        .table {
            width: 100%; border-collapse: collapse; background: var(--white); border-radius: 15px; overflow: hidden;
            box-shadow: var(--shadow-card);
        }
        .table th { background: var(--primary-color); color: var(--white); padding: 1rem; text-align: left; font-weight: 600;}
        .table td { padding: 1rem; border-bottom: 1px solid var(--gray-200);}
        .table tr:hover { background: var(--primary-light);}
        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(45,190,127,0.09); z-index: 2000; animation: fadeIn 0.3s;
        }
        .modal.active {
            display: flex; align-items: center; justify-content: center;
        }
        .modal-content {
            background: var(--white); border-radius: 15px; padding: 2rem; max-width: 500px; width: 95vw; max-height: 80vh; overflow-y: auto;
            animation: slideUp 0.3s;
            box-shadow: var(--shadow-card);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.3rem;}
        .modal-title { font-size: 1.25rem; font-weight: 700; color: var(--text-dark);}
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light);}
        .auth-container {
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            background: var(--gradient);
        }
        .auth-card {
            background: var(--white); padding: 2rem 1.5rem; border-radius: 18px; box-shadow: 0 10px 40px rgba(45,190,127,0.13);
            width: 100%; max-width: 400px;
        }
        .auth-title { text-align: center; font-size: 2rem; font-weight: 700; margin-bottom: 1.3rem; color: var(--text-dark);}
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600; text-transform: uppercase;}
        .status-pending { background: var(--warning); color: var(--white);}
        .status-approved { background: var(--success); color: var(--white);}
        .status-declined { background: var(--error); color: var(--white);}
        .format-currency { font-weight: 600; color: var(--primary-color);}
        .file-link {
            color: var(--primary-color); font-weight: 500; text-decoration: underline; cursor: pointer; margin-right: 8px;
            display: inline-block;
        }
        .file-link:hover { color: var(--primary-dark);}
        /* Settings */
        .settings-cards-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        /* Responsive dashboard and settings for mobile */
        @media (max-width: 900px) {
            .dashboard-grid, .filter-row { grid-template-columns: 1fr 1fr; }
            .settings-cards-row { grid-template-columns: 1fr; }
        }
        @media (max-width: 700px) {
            .dashboard-grid, .filter-row { grid-template-columns: 1fr;}
            .modal-content { max-width: 99vw; padding: 1rem;}
            .settings-cards-row { grid-template-columns: 1fr; }
            /* Responsive dashboard charts: stack below each other instead of side by side */
            .dashboard-charts-row {
                display: flex !important;
                flex-direction: column !important;
                gap: 2rem;
            }
        }
        @media (max-width: 600px) {
            .container { padding: 0 5px;}
            .table thead { display: none;}
            .table, .table tbody, .table tr, .table td { display: block; width: 100%;}
            .table tr { margin-bottom: 1.05rem; border-radius: 8px; box-shadow: 0 1px 6px rgba(45,190,127,0.07); background: var(--white);}
            .table td { text-align: right; padding-left: 50%; position: relative; border: none; border-bottom: 1px solid var(--gray-200);}
            .table td:last-child { border-bottom: none;}
            .table td:before {
                content: attr(data-label); position: absolute; left: 1rem; width: 45%; text-align: left;
                font-weight: 600; color: var(--primary-color); text-transform: capitalize;
            }
            .settings-cards-row { grid-template-columns: 1fr; }
        }
        @media (max-width: 430px) {
            .auth-title { font-size: 1.2rem;}
            .btn, .btn-primary, .btn-secondary, .btn-outline { width: 100%; padding: 0.65rem 0.8rem; font-size: 1rem;}
        }
        .hidden { display: none !important;}
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
    <link rel="stylesheet" href="mobile_responsive.css" />
</head>
<body>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="#" class="logo">{Loan~A}Pro</a>
                <button class="nav-toggle" id="navToggle" aria-label="Menu">&#9776;</button>
                <nav class="nav-menu" id="navMenu">
                    <a href="#" class="nav-link active" onclick="showDashboard()">Dashboard</a>
                    <a href="#" class="nav-link" onclick="showApplications()">Applications</a>
                    <a href="#" class="nav-link" onclick="showSettings()">Settings</a>
                    <a href="#" class="nav-link" onclick="logout()">Logout</a>
                </nav>
            </div>
        </div>
    </header>
    <!-- Login Page -->
    <div id="loginPage" class="auth-container">
        <div class="auth-card">
            <h1 class="auth-title">Login</h1>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">Login</button>
                <div style="text-align: center;">
                    <a href="#" onclick="showSignup()" style="color: var(--primary-color);">Don't have an account? Sign up</a>
                </div>
            </form>
        </div>
    </div>
    <!-- Signup Page -->
    <div id="signupPage" class="auth-container hidden">
        <div class="auth-card">
            <h1 class="auth-title">Sign Up</h1>
            <form onsubmit="signup(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="signupEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="signupPassword" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" class="form-input" id="confirmPassword" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Theme Color</label>
                    <input type="color" class="form-input" id="themeColor" value="#2dbe7f">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">Sign Up</button>
                <div style="text-align: center;">
                    <a href="#" onclick="showLogin()" style="color: var(--primary-color);">Already have an account? Login</a>
                </div>
            </form>
        </div>
    </div>
    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Dashboard -->
        <div id="dashboardPage" class="container" style="padding: 2rem 0;">
            <h1 style="margin-bottom: 2rem; font-size: 2.2rem; font-weight: 700;">Dashboard</h1>
            <div class="dashboard-grid" id="statsGrid">
                <div class="card stat-card">
                    <div class="stat-number" id="totalApplications">0</div>
                    <div class="stat-label">Total Applications</div>
                    <div class="stat-amount" id="totalAmountText">KES 0</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-number" id="pendingApplications">0</div>
                    <div class="stat-label">Pending Applications</div>
                    <div class="stat-amount" id="pendingAmountText">KES 0</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-number" id="approvedApplications">0</div>
                    <div class="stat-label">Approved Applications</div>
                    <div class="stat-amount" id="approvedAmountText">KES 0</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-number" id="declinedApplications">0</div>
                    <div class="stat-label">Declined Applications</div>
                    <div class="stat-amount" id="declinedAmountText">KES 0</div>
                </div>
            </div>
            <!-- Second line of dashboard cards with filter controls -->
            <div class="filter-controls" id="dashboardFilterControls"></div>
            <div class="filter-row" id="filterStatsGrid"></div>
            <!-- Responsive Dashboard Charts Row -->
            <div class="dashboard-charts-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 3rem;">
                <div class="card" style="order:1;">
                    <div class="card-header">
                        <h3 class="card-title">Applications by Status</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
                <div class="card" style="order:2;">
                    <div class="card-header">
                        <h3 class="card-title">Applications by Loan Type</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="loanTypeBarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- Applications Page -->
        <div id="applicationsPage" class="container hidden" style="padding: 2rem 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap;">
                <h1 style="font-size: 2.1rem; font-weight: 700;">Applications</h1>
                <button class="btn btn-primary" onclick="exportToExcel()">Export to Excel</button>
            </div>
            <div class="table-search-row">
                <input type="text" class="table-search-input" id="applicationSearchInput" placeholder="Search (name, mobile, status, type)..." oninput="loadApplicationsTable()">
            </div>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Applicant Name</th>
                            <th>Mobile</th>
                            <th>Loan Amount</th>
                            <th>Tenure</th>
                            <th>Loan Type</th>
                            <th>Payslips</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="applicationsTableBody">
                        <!-- Applications will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Settings Page -->
        <div id="settingsPage" class="container hidden" style="padding: 2rem 0;">
            <h1 style="margin-bottom: 2rem; font-size: 2rem; font-weight: 700;">Settings</h1>
            <div class="settings-cards-row">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Loan Types</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Add New Loan Type</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" class="form-input" id="newLoanType" placeholder="e.g., Personal Loan">
                                <button class="btn btn-primary" onclick="addLoanType()">Add</button>
                            </div>
                        </div>
                        <div id="loanTypesList"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Theme Settings</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Primary Color</label>
                            <input type="color" class="form-input" id="settingsThemeColor" onchange="updateThemeColor()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tenure Limits</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label class="form-label" style="font-size: 0.9rem;">Min (months)</label>
                                    <input type="number" class="form-input" id="minTenure" value="1">
                                </div>
                                <div>
                                    <label class="form-label" style="font-size: 0.9rem;">Max (months)</label>
                                    <input type="number" class="form-input" id="maxTenure" value="60">
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Dashboard Filter Options</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Select Filters to Show on Dashboard</label>
                            <div id="dashboardFilterOptions"></div>
                        </div>
                        <button class="btn btn-primary" onclick="saveDashboardFilters()">Save Filter Preferences</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Public Application Form -->
    <div id="publicForm" class="hidden">
        <div class="container" style="padding: 2rem 0; max-width: 800px;">
            <div class="card">
                <div class="card-header">
                    <h1 class="card-title" style="font-size: 1.7rem;">Loan Application Form</h1>
                    <p style="opacity: 0.92;">Fill out the form below to apply for a loan</p>
                </div>
                <div class="card-body">
                    <form onsubmit="submitApplication(event)">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Loan Amount (KES) *</label>
                                <input type="number" class="form-input" id="loanAmount" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tenure (months) *</label>
                                <input type="number" class="form-input" id="loanTenure" min="1" max="60" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Loan Type *</label>
                                <select class="form-select" id="loanTypeSelect" required></select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Full Name *</label>
                                <input type="text" class="form-input" id="applicantName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Mobile Number *</label>
                                <input type="tel" class="form-input" id="applicantMobile" required>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Email Address *</label>
                                <input type="email" class="form-input" id="applicantEmail" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Job Title *</label>
                                <input type="text" class="form-input" id="applicantJob" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Upload Payslips (Max 3 files) *</label>
                            <input type="file" class="form-input" id="payslips" multiple accept=".pdf,.jpg,.jpeg,.png" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Application Date *</label>
                            <input type="date" class="form-input" id="applicationDate" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Submit Application</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Application Detail Modal -->
    <div id="applicationModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Application Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="applicationDetails"></div>
        </div>
    </div>
    <script>
        let currentUser = null;
        let applications = [];
        let loanTypes = ['Personal Loan', 'Car Loan', 'Emergency Loan', 'Business Loan'];
        const FILE_STORAGE_KEY = "applications_payslips_v2";
        const dashboardFilterDefinitions = [
            {key: 'last_week', label: 'Last week'},
            {key: 'this_month', label: 'This month'},
            {key: 'last_month', label: 'Last month'},
            {key: 'last_3_months', label: 'Last 3 months'},
            {key: 'last_6_months', label: 'Last 6 months'},
            {key: 'last_12_months', label: 'Last 12 months'},
        ];
        let dashboardFilters = [];

        function storePayslips(appId, files) {
            let payslips = JSON.parse(localStorage.getItem(FILE_STORAGE_KEY) || '{}');
            payslips[appId] = [];
            const promises = [];
            for (let i = 0; i < files.length && i < 3; i++) {
                let file = files[i];
                promises.push(new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        payslips[appId].push({
                            name: file.name,
                            type: file.type,
                            data: e.target.result
                        });
                        resolve();
                    };
                    reader.readAsDataURL(file);
                }));
            }
            return Promise.all(promises).then(() => {
                localStorage.setItem(FILE_STORAGE_KEY, JSON.stringify(payslips));
            });
        }
        function getPayslips(appId) {
            let payslips = JSON.parse(localStorage.getItem(FILE_STORAGE_KEY) || '{}');
            return payslips[appId] || [];
        }
        function formatCurrency(amount) {
            if(isNaN(amount)||amount===null||amount===undefined) return 'KES 0';
            return 'KES ' + Number(amount).toLocaleString();
        }
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        function initApp() {
            const user = JSON.parse(localStorage.getItem('currentUser') || 'null');
            const apps = JSON.parse(localStorage.getItem('applications') || '[]');
            const storedLoanTypes = JSON.parse(localStorage.getItem('loanTypes') || 'null');
            if (storedLoanTypes) loanTypes = storedLoanTypes;
            applications = apps;
            const dashboardFilterPrefs = JSON.parse(localStorage.getItem('dashboardFilters') || 'null');
            dashboardFilters = dashboardFilterPrefs || dashboardFilterDefinitions.map(f => f.key);
            if (user) { currentUser = user; showMainApp(); loadUserTheme(); }
            else showLogin();
            populateLoanTypeDropdown();
            // Set default application date
            const appDateInput = document.getElementById('applicationDate');
            if(appDateInput){
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                appDateInput.value = `${yyyy}-${mm}-${dd}`;
            }
        }
        function showLogin() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('signupPage').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('publicForm').classList.add('hidden');
        }
        /* DO NOT SHOW SIGN UP
        function showSignup() {
            document.getElementById('signupPage').classList.remove('hidden');
            document.getElementById('loginPage').classList.add('hidden');
        }
        */
        function showMainApp() {
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('signupPage').classList.add('hidden');
            document.getElementById('publicForm').classList.add('hidden');
            showDashboard();
        }
        /*
        function login(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showMainApp();
                loadUserTheme();
            } else { alert('Invalid credentials!'); }
        }
        */

        // HARD CODED LOGINS
        function login(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            // Hardcoded credentials
            const hardcodedEmail = "jms1kenya@gmail.com";
            const hardcodedPassword = "@james2025";

            if (email === hardcodedEmail && password === hardcodedPassword) {
                const user = { email: hardcodedEmail };
                localStorage.setItem('currentUser', JSON.stringify(user));
                showMainApp();
                loadUserTheme();
            } else {
                alert('Invalid credentials!');
            }
        }
        function signup(event) {
            event.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const themeColor = document.getElementById('themeColor').value;
            if (password !== confirmPassword) { alert('Passwords do not match!'); return; }
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            if (users.find(u => u.email === email)) { alert('User already exists!'); return; }
            const newUser = {
                id: generateId(), email, password, themeColor, createdAt: new Date().toISOString()
            };
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            currentUser = newUser;
            localStorage.setItem('currentUser', JSON.stringify(newUser));
            showMainApp();
            loadUserTheme();
        }
        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            showLogin();
        }
        function loadUserTheme() {
            if (currentUser && currentUser.themeColor) {
                updateThemeColor(currentUser.themeColor);
                document.getElementById('settingsThemeColor').value = currentUser.themeColor;
            }
        }
        function updateThemeColor(color = null) {
            const themeColor = color || document.getElementById('settingsThemeColor').value;
            document.documentElement.style.setProperty('--primary-color', themeColor);
            document.documentElement.style.setProperty('--gradient', `linear-gradient(135deg, ${themeColor} 0%, var(--primary-dark) 100%)`);
            if (currentUser) {
                currentUser.themeColor = themeColor;
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex] = currentUser;
                    localStorage.setItem('users', JSON.stringify(users));
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
            }
        }
        function showDashboard() {
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector('.nav-link[onclick="showDashboard()"]').classList.add('active');
            document.getElementById('dashboardPage').classList.remove('hidden');
            document.getElementById('applicationsPage').classList.add('hidden');
            document.getElementById('settingsPage').classList.add('hidden');
            updateDashboardStats();
            updateCharts();
            renderDashboardFilters();
        }
        function showApplications() {
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector('.nav-link[onclick="showApplications()"]').classList.add('active');
            document.getElementById('applicationsPage').classList.remove('hidden');
            document.getElementById('dashboardPage').classList.add('hidden');
            document.getElementById('settingsPage').classList.add('hidden');
            loadApplicationsTable();
        }
        function showSettings() {
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector('.nav-link[onclick="showSettings()"]').classList.add('active');
            document.getElementById('settingsPage').classList.remove('hidden');
            document.getElementById('dashboardPage').classList.add('hidden');
            document.getElementById('applicationsPage').classList.add('hidden');
            loadSettings();
        }
        function updateDashboardStats() {
            const total = applications.length;
            const pending = applications.filter(app => app.status === 'pending').length;
            const approved = applications.filter(app => app.status === 'approved').length;
            const declined = applications.filter(app => app.status === 'declined').length;
            document.getElementById('totalApplications').textContent = total;
            document.getElementById('pendingApplications').textContent = pending;
            document.getElementById('approvedApplications').textContent = approved;
            document.getElementById('declinedApplications').textContent = declined;
            let totalAmount = 0, pendingAmount = 0, approvedAmount = 0, declinedAmount = 0;
            applications.forEach(app => {
                const amt = parseFloat(app.loanAmount) || 0;
                totalAmount += amt;
                if(app.status === 'pending') pendingAmount += amt;
                if(app.status === 'approved') approvedAmount += amt;
                if(app.status === 'declined') declinedAmount += amt;
            });
            document.getElementById('totalAmountText').textContent = formatCurrency(totalAmount);
            document.getElementById('pendingAmountText').textContent = formatCurrency(pendingAmount);
            document.getElementById('approvedAmountText').textContent = formatCurrency(approvedAmount);
            document.getElementById('declinedAmountText').textContent = formatCurrency(declinedAmount);
        }
        function updateCharts() {
            if (window.statusChartObj) window.statusChartObj.destroy();
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            const pending = applications.filter(app => app.status === 'pending').length;
            const approved = applications.filter(app => app.status === 'approved').length;
            const declined = applications.filter(app => app.status === 'declined').length;
            window.statusChartObj = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'Approved', 'Declined'],
                    datasets: [{
                        data: [pending, approved, declined],
                        backgroundColor: ['#D69E2E', '#38A169', '#E53E3E'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
            if (window.loanTypeBarChartObj) window.loanTypeBarChartObj.destroy();
            const loanTypeBarCtx = document.getElementById('loanTypeBarChart').getContext('2d');
            const loanTypeData = {};
            applications.forEach(app => {
                const type = app.loanType || 'Personal Loan';
                loanTypeData[type] = (loanTypeData[type] || 0) + 1;
            });
            window.loanTypeBarChartObj = new Chart(loanTypeBarCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(loanTypeData),
                    datasets: [{
                        label: 'Loans by Type',
                        data: Object.values(loanTypeData),
                        backgroundColor: [
                            'rgba(45,190,127,0.8)',
                            'rgba(30,150,100,0.8)',
                            'rgba(60,220,160,0.8)',
                            'rgba(24,100,70,0.8)',
                            'rgba(80,220,180,0.8)',
                            'rgba(10,130,90,0.8)'
                        ],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: "Loan Type" }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 },
                            title: { display: true, text: "Applications" }
                        }
                    }
                }
            });
        }
        function renderDashboardFilters() {
            const filterList = dashboardFilterDefinitions.filter(f => dashboardFilters.includes(f.key));
            const controls = document.getElementById('dashboardFilterControls');
            controls.innerHTML = '';
            let selected = window.selectedDashboardFilter || filterList[0]?.key || '';
            if (!selected && filterList.length > 0) selected = filterList[0].key;
            window.selectedDashboardFilter = selected;
            filterList.forEach(f => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn' + (selected === f.key ? ' active' : '');
                btn.textContent = f.label;
                btn.onclick = () => {
                    window.selectedDashboardFilter = f.key;
                    renderDashboardFilters();
                };
                controls.appendChild(btn);
            });
            renderDashboardFilterCards(selected);
        }
        function renderDashboardFilterCards(selectedKey) {
            const grid = document.getElementById('filterStatsGrid');
            if (!selectedKey) { grid.innerHTML = ''; return; }
            let filterStart = null, filterEnd = new Date();
            const now = new Date();
            switch(selectedKey) {
                case 'last_week': {
                    // Previous week: Monday to Sunday
                    const curDay = now.getDay() || 7;
                    const thisMonday = new Date(now);
                    thisMonday.setDate(now.getDate() - curDay + 1);
                    const lastWeekStart = new Date(thisMonday);
                    lastWeekStart.setDate(thisMonday.getDate() - 7);
                    const lastWeekEnd = new Date(thisMonday);
                    lastWeekEnd.setDate(thisMonday.getDate() - 1);
                    filterStart = new Date(lastWeekStart.setHours(0,0,0,0));
                    filterEnd = new Date(lastWeekEnd.setHours(23,59,59,999));
                    break;
                }
                case 'this_month': {
                    filterStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                }
                case 'last_month': {
                    const y = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
                    const m = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
                    filterStart = new Date(y, m, 1);
                    filterEnd = new Date(y, m + 1, 0, 23, 59, 59);
                    break;
                }
                case 'last_3_months': {
                    filterStart = new Date(now.getFullYear(), now.getMonth() - 3, 1);
                    break;
                }
                case 'last_6_months': {
                    filterStart = new Date(now.getFullYear(), now.getMonth() - 6, 1);
                    break;
                }
                case 'last_12_months': {
                    filterStart = new Date(now.getFullYear(), now.getMonth() - 12, 1);
                    break;
                }
                default:
                    filterStart = null;
            }
            let filtered = applications.filter(app => {
                if (!app.submittedAt) return false;
                const dt = new Date(app.submittedAt);
                if (selectedKey === 'last_month' || selectedKey === 'last_week') {
                    return dt >= filterStart && dt <= filterEnd;
                }
                return (!filterStart || dt >= filterStart) && (!filterEnd || dt <= filterEnd);
            });
            const total = filtered.length;
            const pending = filtered.filter(app => app.status === 'pending').length;
            const approved = filtered.filter(app => app.status === 'approved').length;
            const declined = filtered.filter(app => app.status === 'declined').length;
            let totalAmount = 0, pendingAmount = 0, approvedAmount = 0, declinedAmount = 0;
            filtered.forEach(app => {
                const amt = parseFloat(app.loanAmount) || 0;
                totalAmount += amt;
                if(app.status === 'pending') pendingAmount += amt;
                if(app.status === 'approved') approvedAmount += amt;
                if(app.status === 'declined') declinedAmount += amt;
            });
            grid.innerHTML = `
                <div class="card stat-card">
                    <div class="stat-number">${total}</div>
                    <div class="stat-label">Total Applications</div>
                    <div class="stat-amount">${formatCurrency(totalAmount)}</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-number">${pending}</div>
                    <div class="stat-label">Pending Applications</div>
                    <div class="stat-amount">${formatCurrency(pendingAmount)}</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-number">${approved}</div>
                    <div class="stat-label">Approved Applications</div>
                    <div class="stat-amount">${formatCurrency(approvedAmount)}</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-number">${declined}</div>
                    <div class="stat-label">Declined Applications</div>
                    <div class="stat-amount">${formatCurrency(declinedAmount)}</div>
                </div>
            `;
        }
        function loadApplicationsTable() {
            const tbody = document.getElementById('applicationsTableBody');
            const search = (document.getElementById('applicationSearchInput')?.value || '').toLowerCase();
            tbody.innerHTML = '';
            let displayApps = [...applications].sort((a, b) => {
                const da = new Date(a.submittedAt || 0), db = new Date(b.submittedAt || 0);
                return db - da;
            });
            if (search) {
                displayApps = displayApps.filter(app =>
                    (app.fullName && app.fullName.toLowerCase().includes(search)) ||
                    (app.mobile && app.mobile.toLowerCase().includes(search)) ||
                    (app.status && app.status.toLowerCase().includes(search)) ||
                    (app.loanType && app.loanType.toLowerCase().includes(search))
                );
            }
            displayApps.forEach(app => {
                const payslips = getPayslips(app.id);
                let payslipHtml = payslips.length
                    ? payslips.map((file) =>
                        `<a class="file-link" href="${file.data}" download="${file.name}" target="_blank">${file.name}</a>`
                    ).join('<br>')
                    : '<span style="color:#aaa">No files</span>';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Name">${app.fullName}</td>
                    <td data-label="Mobile">${app.mobile}</td>
                    <td data-label="Amount" class="format-currency">${formatCurrency(app.loanAmount)}</td>
                    <td data-label="Tenure">${app.tenure} months</td>
                    <td data-label="Loan Type">${app.loanType || "Personal Loan"}</td>
                    <td data-label="Payslips">${payslipHtml}</td>
                    <td data-label="Status"><span class="status-badge status-${app.status}">${app.status}</span></td>
                    <td data-label="Actions">
                        <button class="btn btn-secondary btn-sm" style="margin-bottom:4px;" onclick="viewApplication('${app.id}')">View</button>
                        <button class="btn btn-outline btn-sm" onclick="shareWhatsApp('${app.id}')">Share</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        function viewPayslip(appId, idx) {
            const payslips = getPayslips(appId);
            if (!payslips[idx]) return;
            window.open(payslips[idx].data, '_blank');
        }
        function viewApplication(applicationId) {
            const app = applications.find(a => a.id === applicationId);
            if (!app) return;
            const modal = document.getElementById('applicationModal');
            const details = document.getElementById('applicationDetails');
            const payslips = getPayslips(app.id);
            let payslipHtml = payslips.length ? payslips.map((file) =>
                `<a class="file-link" href="${file.data}" download="${file.name}" target="_blank">${file.name}</a>`
            ).join('<br>') : '<span style="color:#aaa">No files</span>';
            details.innerHTML = `
                <div style="margin-bottom: 1.2rem;">
                    <h3 style="margin-bottom: 0.7rem; color: var(--primary-color);">Personal Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div><strong>Full Name:</strong> ${app.fullName}</div>
                        <div><strong>Mobile:</strong> ${app.mobile}</div>
                        <div><strong>Email:</strong> ${app.email}</div>
                        <div><strong>Job Title:</strong> ${app.jobTitle}</div>
                    </div>
                </div>
                <div style="margin-bottom: 1.2rem;">
                    <h3 style="margin-bottom: 0.7rem; color: var(--primary-color);">Loan Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div><strong>Amount:</strong> <span class="format-currency">${formatCurrency(app.loanAmount)}</span></div>
                        <div><strong>Tenure:</strong> ${app.tenure} months</div>
                        <div><strong>Loan Type:</strong> ${app.loanType || "Personal Loan"}</div>
                        <div><strong>Status:</strong> <span class="status-badge status-${app.status}">${app.status}</span></div>
                    </div>
                </div>
                <div style="margin-bottom: 1.2rem;">
                    <h3 style="margin-bottom: 0.7rem; color: var(--primary-color);">Payslips</h3>
                    ${payslipHtml}
                </div>
                <div style="margin-bottom: 1.2rem;">
                    <h3 style="margin-bottom: 0.7rem; color: var(--primary-color);">Application Date</h3>
                    <p>${new Date(app.applicationDate || app.submittedAt).toLocaleDateString()}</p>
                </div>
                ${app.notes ? `
                    <div style="margin-bottom: 1.2rem;">
                        <h3 style="margin-bottom: 0.7rem; color: var(--primary-color);">Processing Notes</h3>
                        <p style="background: var(--gray-100); padding: 0.8rem; border-radius: 8px;">${app.notes}</p>
                    </div>
                ` : ''}
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-primary btn-sm" onclick="downloadApplicationPDF('${app.id}')">Download PDF</button>
                    <button class="btn btn-secondary btn-sm" onclick="shareWhatsApp('${app.id}')">Share WhatsApp</button>
                    ${app.status === 'pending' ? `<button class="btn btn-outline btn-sm" onclick="processApplication('${app.id}')">Process Application</button>` : ''}
                </div>
            `;
            modal.classList.add('active');
        }
        function processApplication(applicationId) {
            const app = applications.find(a => a.id === applicationId);
            if (!app) return;
            const action = prompt('Enter action (approve/decline):');
            if (!action || !['approve', 'decline'].includes(action.toLowerCase())) {
                alert('Invalid action. Please enter "approve" or "decline".');
                return;
            }
            const notes = prompt('Add processing notes (optional):') || '';
            app.status = action.toLowerCase() === 'approve' ? 'approved' : 'declined';
            app.processedAt = new Date().toISOString();
            app.notes = notes;
            localStorage.setItem('applications', JSON.stringify(applications));
            if (!document.getElementById('applicationsPage').classList.contains('hidden')) loadApplicationsTable();
            if (!document.getElementById('dashboardPage').classList.contains('hidden')) {
                updateDashboardStats(); updateCharts(); renderDashboardFilters();
            }
            closeModal();
            alert(`Application ${app.status} successfully!`);
        }
        function downloadApplicationPDF(applicationId) {
            const app = applications.find(a => a.id === applicationId);
            if (!app) return;
            const payslips = getPayslips(app.id);
            const tempDiv = document.createElement('div');
            tempDiv.style.padding = '2rem';
            tempDiv.style.backgroundColor = 'white';
            tempDiv.style.fontFamily = 'Arial, sans-serif';
            tempDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #2dbe7f; padding-bottom: 1rem;">
                    <h1 style="color: #2dbe7f; margin: 0;">Loan Application</h1>
                    <p style="margin: 0.5rem 0 0 0; color: #666;">Application ID: ${app.id}</p>
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <h2 style="color: #2dbe7f; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">Personal Information</h2>
                    <table style="width: 100%; margin-top: 1rem;">
                        <tr><td style="padding: 0.5rem 0; font-weight: bold;">Full Name:</td><td style="padding: 0.5rem 0;">${app.fullName}</td></tr>
                        <tr><td style="padding: 0.5rem 0; font-weight: bold;">Mobile:</td><td style="padding: 0.5rem 0;">${app.mobile}</td></tr>
                        <tr><td style="padding: 0.5rem 0; font-weight: bold;">Email:</td><td style="padding: 0.5rem 0;">${app.email}</td></tr>
                        <tr><td style="padding: 0.5rem 0; font-weight: bold;">Job Title:</td><td style="padding: 0.5rem 0;">${app.jobTitle}</td></tr>
                    </table>
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <h2 style="color: #2dbe7f; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">Loan Details</h2>
                    <table style="width: 100%; margin-top: 1rem;">
                        <tr><td style="padding: 0.5rem 0; font-weight: bold;">Loan Amount:</td><td style="padding: 0.5rem 0; color: #2dbe7f; font-weight: bold;">${formatCurrency(app.loanAmount)}</td></tr>
                        <tr><td style="padding: 0.5rem 0; font-weight: bold;">Tenure:</td><td style="padding: 0.5rem 0;">${app.tenure} months</td></tr>
                        <tr><td style="padding: 0.5rem 0; font-weight: bold;">Loan Type:</td><td style="padding: 0.5rem 0;">${app.loanType || "Personal Loan"}</td></tr>
                        <tr><td style="padding: 0.5rem 0; font-weight: bold;">Status:</td><td style="padding: 0.5rem 0; text-transform: uppercase; font-weight: bold;">${app.status}</td></tr>
                        <tr><td style="padding: 0.5rem 0; font-weight: bold;">Submitted:</td><td style="padding: 0.5rem 0;">${new Date(app.submittedAt).toLocaleDateString()}</td></tr>
                        <tr><td style="padding: 0.5rem 0; font-weight: bold;">Application Date:</td><td style="padding: 0.5rem 0;">${app.applicationDate ? new Date(app.applicationDate).toLocaleDateString() : new Date(app.submittedAt).toLocaleDateString()}</td></tr>
                    </table>
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <h2 style="color: #2dbe7f; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">Payslips</h2>
                    ${payslips.length ? payslips.map(file => `<div>${file.name}</div>`).join('') : 'No files'}
                </div>
                ${app.notes ? `
                    <div style="margin-bottom: 1.5rem;">
                        <h2 style="color: #2dbe7f; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">Processing Notes</h2>
                        <p style="background: #f5f5f5; padding: 1rem; border-radius: 8px; margin-top: 1rem;">${app.notes}</p>
                    </div>
                ` : ''}
            `;
            document.body.appendChild(tempDiv);
            html2canvas(tempDiv).then(canvas => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                pdf.save(`loan-application-${app.id}.pdf`);
                document.body.removeChild(tempDiv);
            });
        }
        function shareWhatsApp(applicationId) {
            const app = applications.find(a => a.id === applicationId);
            if (!app) return;
            const message = `*Loan Application Details*\n\n` +
                `*Applicant:* ${app.fullName}\n` +
                `*Mobile:* ${app.mobile}\n` +
                `*Email:* ${app.email}\n` +
                `*Job:* ${app.jobTitle}\n` +
                `*Amount:* ${formatCurrency(app.loanAmount)}\n` +
                `*Tenure:* ${app.tenure} months\n` +
                `*Loan Type:* ${app.loanType || "Personal Loan"}\n` +
                `*Status:* ${app.status.toUpperCase()}\n` +
                `*Submitted:* ${new Date(app.submittedAt).toLocaleDateString()}\n\n` +
                `Application ID: ${app.id}`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }
        function exportToExcel() {
            const worksheet = XLSX.utils.json_to_sheet(applications.map(app => ({
                'Application ID': app.id,
                'Full Name': app.fullName,
                'Mobile': app.mobile,
                'Email': app.email,
                'Job Title': app.jobTitle,
                'Loan Amount': app.loanAmount,
                'Tenure': app.tenure + ' months',
                'Loan Type': app.loanType || "Personal Loan",
                'Status': app.status,
                'Submitted Date': new Date(app.submittedAt).toLocaleDateString(),
                'Application Date': app.applicationDate ? new Date(app.applicationDate).toLocaleDateString() : '',
                'Notes': app.notes || ''
            })));
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Applications');
            XLSX.writeFile(workbook, 'loan-applications.xlsx');
        }
        function loadSettings() {
            const loanTypesList = document.getElementById('loanTypesList');
            loanTypesList.innerHTML = '';
            loanTypes.forEach((type, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--gray-100); border-radius: 8px; margin-bottom: 0.5rem;';
                div.innerHTML = `<span>${type}</span>
                    <button class="btn btn-secondary btn-sm" onclick="removeLoanType(${index})">Remove</button>`;
                loanTypesList.appendChild(div);
            });
            populateLoanTypeDropdown();
            const settings = JSON.parse(localStorage.getItem('settings') || '{}');
            document.getElementById('minTenure').value = settings.minTenure || 1;
            document.getElementById('maxTenure').value = settings.maxTenure || 60;
            const filterOptionsDiv = document.getElementById('dashboardFilterOptions');
            filterOptionsDiv.innerHTML = '';
            dashboardFilterDefinitions.forEach(def => {
                const label = document.createElement('label');
                label.style.display = "block";
                label.style.marginBottom = "0.5rem";
                label.style.cursor = "pointer";
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.value = def.key;
                input.checked = dashboardFilters.includes(def.key);
                input.style.marginRight = "0.5rem";
                label.appendChild(input);
                label.appendChild(document.createTextNode(def.label));
                filterOptionsDiv.appendChild(label);
            });
        }
        function addLoanType() {
            const input = document.getElementById('newLoanType');
            const type = input.value.trim();
            if (!type) { alert('Please enter a loan type'); return; }
            if (loanTypes.includes(type)) { alert('Loan type already exists'); return; }
            loanTypes.push(type);
            localStorage.setItem('loanTypes', JSON.stringify(loanTypes));
            input.value = '';
            loadSettings();
        }
        function removeLoanType(index) {
            if (confirm('Are you sure you want to remove this loan type?')) {
                loanTypes.splice(index, 1);
                localStorage.setItem('loanTypes', JSON.stringify(loanTypes));
                loadSettings();
            }
        }
        function saveSettings() {
            const settings = {
                minTenure: parseInt(document.getElementById('minTenure').value),
                maxTenure: parseInt(document.getElementById('maxTenure').value)
            };
            localStorage.setItem('settings', JSON.stringify(settings));
            alert('Settings saved successfully!');
        }
        function saveDashboardFilters() {
            const checkboxes = document.getElementById('dashboardFilterOptions').querySelectorAll('input[type="checkbox"]');
            dashboardFilters = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            localStorage.setItem('dashboardFilters', JSON.stringify(dashboardFilters));
            alert('Dashboard filter preferences saved!');
            if (!document.getElementById('dashboardPage').classList.contains('hidden')) renderDashboardFilters();
        }
        function populateLoanTypeDropdown() {
            const select = document.getElementById('loanTypeSelect');
            if (!select) return;
            select.innerHTML = '';
            loanTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                select.appendChild(option);
            });
        }
        function showPublicForm() {
            document.getElementById('publicForm').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('signupPage').classList.add('hidden');
            populateLoanTypeDropdown();
            // Set today's date by default
            const appDateInput = document.getElementById('applicationDate');
            if(appDateInput){
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                appDateInput.value = `${yyyy}-${mm}-${dd}`;
            }
        }
        function submitApplication(event) {
            event.preventDefault();
            const payslipInput = document.getElementById('payslips');
            const files = payslipInput.files;
            if (!files || files.length === 0) {
                alert("Please attach at least one payslip.");
                return;
            }
            const application = {
                id: generateId(),
                fullName: document.getElementById('applicantName').value,
                mobile: document.getElementById('applicantMobile').value,
                email: document.getElementById('applicantEmail').value,
                jobTitle: document.getElementById('applicantJob').value,
                loanAmount: parseInt(document.getElementById('loanAmount').value),
                tenure: parseInt(document.getElementById('loanTenure').value),
                loanType: document.getElementById('loanTypeSelect').value || "Personal Loan",
                payslips: [],
                status: 'pending',
                applicationDate: document.getElementById('applicationDate').value,
                submittedAt: new Date().toISOString()
            };
            applications.push(application);
            localStorage.setItem('applications', JSON.stringify(applications));
            storePayslips(application.id, files).then(()=>{
                alert('Application submitted successfully! You will be contacted soon.');
                event.target.reset();
                // Reset application date back to today
                const appDateInput = document.getElementById('applicationDate');
                if(appDateInput){
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    appDateInput.value = `${yyyy}-${mm}-${dd}`;
                }
            });
        }
        function closeModal() {
            document.getElementById('applicationModal').classList.remove('active');
        }
        // Responsive Nav Toggle
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            var navToggle = document.getElementById('navToggle');
            var navMenu = document.getElementById('navMenu');
            navToggle.addEventListener('click', function() {
                navMenu.classList.toggle('show');
            });
        });
        function goToPublicForm() { showPublicForm(); }
        document.getElementById('applicationModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    </script>
    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
        <button class="btn btn-primary" onclick="goToPublicForm()" style="border-radius: 50px; padding: 1rem 1.5rem;">
             Apply for Loan
        </button>
    </div>
</body>
</html>